<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>维度与指标绑定关系测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-case { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>维度与指标绑定关系测试</h1>
    
    <div class="test-section">
        <h2>测试数据一致性检查功能</h2>
        
        <div class="test-case">
            <h3>测试用例1：数据源匹配的维度和指标</h3>
            <p><strong>预期结果：</strong>通过验证</p>
            <div id="test1">等待测试...</div>
        </div>
        
        <div class="test-case">
            <h3>测试用例2：数据源不匹配的维度和指标</h3>
            <p><strong>预期结果：</strong>验证失败，显示警告</p>
            <div id="test2">等待测试...</div>
        </div>
        
        <div class="test-case">
            <h3>测试用例3：智能维度推荐</h3>
            <p><strong>预期结果：</strong>返回按优先级排序的维度列表</p>
            <div id="test3">等待测试...</div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>功能说明</h2>
        <ul>
            <li><strong>维度与指标绑定关系：</strong>通过数据源一致性实现弱绑定</li>
            <li><strong>数据一致性检查：</strong>在保存数据卡片时验证维度和指标的兼容性</li>
            <li><strong>智能维度筛选：</strong>根据指标自动筛选可用的维度</li>
            <li><strong>兼容性提示：</strong>显示维度与指标的匹配状态</li>
            <li><strong>配置验证：</strong>检查图表类型与维度类型的兼容性</li>
        </ul>
    </div>

    <script>
        // 模拟维度管理器
        const dimensions = [
            { id: 1, name: 'order_date', displayName: '订单日期', type: 'time', dataSourceId: 1 },
            { id: 2, name: 'product_category', displayName: '产品类别', type: 'business', dataSourceId: 1 },
            { id: 3, name: 'region', displayName: '地区', type: 'geography', dataSourceId: 1 },
            { id: 4, name: 'visit_date', displayName: '访问日期', type: 'time', dataSourceId: 2 },
            { id: 5, name: 'page_category', displayName: '页面类别', type: 'business', dataSourceId: 2 }
        ];

        // 模拟指标管理器
        const metrics = [
            { id: 1, name: 'total_sales', displayName: '总销售额', dataSourceId: 1 },
            { id: 2, name: 'active_users', displayName: '活跃用户数', dataSourceId: 2 }
        ];

        // 数据一致性检查函数
        function validateDimensionMetricCompatibility(dimension, metric) {
            return dimension.dataSourceId === metric.dataSourceId;
        }

        // 智能推荐维度
        function recommendDimensions(metricId) {
            const metric = metrics.find(m => m.id === metricId);
            if (!metric) return [];
            
            const compatibleDimensions = dimensions.filter(d => d.dataSourceId === metric.dataSourceId);
            
            // 根据维度类型进行智能排序：时间维度 > 地理维度 > 业务维度
            return compatibleDimensions.sort((a, b) => {
                const typePriority = { 'time': 3, 'geography': 2, 'business': 1 };
                return (typePriority[b.type] || 0) - (typePriority[a.type] || 0);
            });
        }

        // 执行测试
        function runTests() {
            // 测试用例1：数据源匹配
            const test1Dimension = dimensions[0]; // 订单日期（数据源1）
            const test1Metric = metrics[0]; // 总销售额（数据源1）
            const test1Result = validateDimensionMetricCompatibility(test1Dimension, test1Metric);
            document.getElementById('test1').innerHTML = 
                test1Result ? 
                '<span class="success">✅ 测试通过：维度与指标数据源匹配</span>' :
                '<span class="error">❌ 测试失败：维度与指标数据源不匹配</span>';

            // 测试用例2：数据源不匹配
            const test2Dimension = dimensions[3]; // 访问日期（数据源2）
            const test2Metric = metrics[0]; // 总销售额（数据源1）
            const test2Result = validateDimensionMetricCompatibility(test2Dimension, test2Metric);
            document.getElementById('test2').innerHTML = 
                !test2Result ? 
                '<span class="success">✅ 测试通过：正确识别数据源不匹配</span>' :
                '<span class="error">❌ 测试失败：未能识别数据源不匹配</span>';

            // 测试用例3：智能维度推荐
            const test3Recommended = recommendDimensions(1); // 推荐总销售额的维度
            const test3Result = test3Recommended.length > 0 && 
                              test3Recommended[0].type === 'time'; // 时间维度应优先
            document.getElementById('test3').innerHTML = 
                test3Result ? 
                `<span class="success">✅ 测试通过：智能推荐了 ${test3Recommended.length} 个维度，优先推荐时间维度</span>` :
                '<span class="error">❌ 测试失败：维度推荐功能异常</span>';
                
            console.log('推荐的维度：', test3Recommended);
        }

        // 页面加载完成后运行测试
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>